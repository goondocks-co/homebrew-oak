name: Update oak-ci formula

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to update to (e.g., 1.0.5)"
        required: true

permissions:
  contents: write

jobs:
  update:
    name: Update Formula
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Wait for PyPI availability
        env:
          TARGET_VERSION: ${{ inputs.version }}
        run: |
          for i in $(seq 1 10); do
            if pip index versions oak-ci 2>/dev/null | grep -q "$TARGET_VERSION"; then
              echo "oak-ci $TARGET_VERSION found on PyPI"
              exit 0
            fi
            echo "Waiting for oak-ci $TARGET_VERSION on PyPI... (attempt $i/10)"
            sleep 30
          done
          echo "::error::oak-ci $TARGET_VERSION not found on PyPI after 5 minutes"
          exit 1

      - name: Generate formula
        env:
          TARGET_VERSION: ${{ inputs.version }}
        run: |
          python3 scripts/patch_formula.py Formula/oak-ci.rb \
            --version "$TARGET_VERSION"

      - name: Validate formula
        run: |
          brew audit --formula Formula/oak-ci.rb || true

      - name: Commit and push
        env:
          TARGET_VERSION: ${{ inputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/oak-ci.rb
          git diff --staged --quiet || git commit -m "Update oak-ci to $TARGET_VERSION"
          git push
