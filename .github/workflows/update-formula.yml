name: Update oak-ci formula

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to update to (e.g., 1.0.5)"
        required: true

permissions:
  contents: write

jobs:
  update:
    name: Update Formula
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Wait for PyPI availability
        env:
          TARGET_VERSION: ${{ inputs.version }}
        run: |
          # Use pip download (hits the simple index, same as pip install)
          # rather than pip index versions (hits the JSON API) to verify
          # the package is actually installable, not just listed.
          tmpdir=$(mktemp -d)
          for i in $(seq 1 20); do
            if pip download --no-deps "oak-ci==$TARGET_VERSION" -d "$tmpdir" 2>/dev/null; then
              echo "oak-ci $TARGET_VERSION downloadable from PyPI"
              rm -rf "$tmpdir"
              exit 0
            fi
            echo "Waiting for oak-ci $TARGET_VERSION on PyPI... (attempt $i/20)"
            sleep 30
          done
          rm -rf "$tmpdir"
          echo "::error::oak-ci $TARGET_VERSION not installable from PyPI after 10 minutes"
          exit 1

      - name: Generate formula
        env:
          TARGET_VERSION: ${{ inputs.version }}
        run: |
          python3 scripts/patch_formula.py Formula/oak-ci.rb \
            --version "$TARGET_VERSION"

      - name: Validate formula
        run: |
          brew audit --formula Formula/oak-ci.rb || true

      - name: Commit and push
        env:
          TARGET_VERSION: ${{ inputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/oak-ci.rb
          git diff --staged --quiet || git commit -m "Update oak-ci to $TARGET_VERSION"
          git push
